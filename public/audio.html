<script>
  var context;

  var frequencybox;
  var wavebox;
  var audio;


  function initialize() {
    context = new webkitAudioContext();

    // Setup frequency domain graph
    frequencybox = new SpectrumBox(2048, 30, "fftbox", context);
    frequencybox.setValidPoints(500);
    frequencybox.getCanvasContext().fillStyle = "rgb(150, 150, 150)";

    // Setup time domain graph
    wavebox = new SpectrumBox(2048, 1000, "wavebox", context);
    wavebox.setType(SpectrumBox.Types.TIME);
    wavebox.getCanvasContext().fillStyle = "rgb(255, 0, 0)";

    // Load MP3
    audio = new RemoteAudioPlayer(context, "track.mp3");
    audio.load(function() {
      $('#play').text("Play");
      $('#play').click(play);
    });
  }


  function play() {
    var source = audio.getSource();
    var wavenode = wavebox.getAudioNode();
    var frequencynode = frequencybox.getAudioNode();

    // Route audio and graphs
    source.connect(frequencynode);
    frequencynode.connect(wavenode)
    wavenode.connect(context.destination);

    // Play audio
    audio.reload();
    source.noteOn(0);

    // Enable graphs
    wavebox.enable();
    frequencybox.enable();

    $('#play').text("Stop");
    $('#play').click(stop);
  }


  function stop() {
    // Disable graphs
    wavebox.disable();
    frequencybox.disable();
    audio.getSource().disconnect();

    $('#play').text("Play");
    $('#play').click(play);
  }

  $(function() { initialize(); });

</script>

<div class="row">
  <h1>Audio Visualizer</h1>
</div>

<div class="row">
  <div id="canvasbox">
    <canvas id="fftbox" width=500 height=100></canvas>
    <canvas id="wavebox" width=500 height=100></canvas>
  </div>
</div>

<p/>

<div class="row">
  <a class="btn btn-primary" href="#" id="play">Loading...</a>
</div>
